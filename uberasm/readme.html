<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8">
        <title>UberASM Tool Readme</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- <link rel="stylesheet" href="github-markdown-dark.css"> -->

        <style>
            body
            {
                margin: 10px auto;
                padding: 45px;
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                color: #c9d1d9;
                background-color: rgb(36, 36, 36);
                font-family: Helvetica,Arial,sans-serif;
                font-size: 16px;
                line-height: 1.5;
                word-wrap: break-word;
                text-align: justify;
            }

            a
            {
                background-color: transparent;
                color: #58a6ff;
            }

            a:not(.toclink)[href^="#"]::before
            {
                content: "\a7 \a0";  /* section marker, nbsp */
            }

            a:hover
            {
                text-decoration: none;
            }

            strong
            {
                font-weight: 600;
            }

            hr
            {
                box-sizing: content-box;
                overflow: hidden;
                background: transparent;
                border-bottom: 1px solid #21262d;
                height: .25em;
                padding: 0;
                margin: 24px 0;
                background-color: #30363d;
                border: 0;
            }

            h1,
            h2,
            h3
            {
              margin-top: 24px;
              margin-bottom: 16px;
              font-weight: 600;
              line-height: 1.25;
            }

            h1
            {
                margin: .67em 0;
                font-weight: 600;
                padding-bottom: .3em;
                font-size: 2em;
                border-bottom: 1px solid #21262d;
            }

            h2
            {
                padding-bottom: .3em;
                font-size: 1.5em;
                border-bottom: 1px solid #21262d;
            }

            h3
            {
                font-size: 1.25em;
            }

            ul,
            ol
            {
                margin-top: 0;
                margin-bottom: 0;
                padding-left: 2em;
            }

            dd
            {
                margin-left: 0;
            }

            p,
            ul,
            ol,
            dl,
            pre
            {
                margin-top: 0;
                margin-bottom: 16px;
            }

            ul ul,
            ul ol,
            ol ol,
            ol ul
            {
                margin-top: 0;
                margin-bottom: 0;
            }

            li>p
            {
                margin-top: 16px;
            }

            li+li
            {
              margin-top: .25em;
            }

            dl
            {
                padding: 0;
            }

            dl dt
            {
                padding: 0;
                margin-top: 16px;
                font-size: 1em;
                font-weight: 600;
            }

            dt+dt
            {
                margin-top: 4px;
            }

            dl dd
            {
                padding: 0 16px;
            }

            code,
            pre
            {
                font-family: monospace;
            }

            code
            {
                padding: .2em .4em;
                margin: 0;
                font-size: 85%;
                background-color: rgb(24,24,24);
                border: 2px solid rgb(18,18,18);
                border-radius: 6px;
            }

            code.path
            {
                border: none;
            }

            pre
            {
                margin-top: 0;
                margin-bottom: 1em;
                margin-left: 30px;
                margin-right: 30px;
                padding: 16px;
                overflow: auto;
                line-height: 1.2;
                background-color: rgb(24,24,24);
                border: 2px solid rgb(18,18,18);
                border-radius: 6px;
            }
        </style>
    </head>

    <body>
<pre>
 _    _ _                       _____ __  __   _______          _
| |  | | |               /\    / ____|  \/  | |__   __|        | |
| |  | | |__   ___ _ __ /  \  | (___ | \  / |    | | ___   ___ | |
| |  | | '_ \ / _ \ '__/ /\ \  \___ \| |\/| |    | |/ _ \ / _ \| |
| |__| | |_) |  __/ | / ____ \ ____) | |  | |    | | (_) | (_) | |
 \____/|_.__/ \___|_|/_/    \_\_____/|_|  |_|    |_|\___/ \___/|_|
         Version 2.0                By Vitor Vilela & Fernap
</pre>

        <p>
            Thank you for downloading UberASM Tool.  We hope it helps you on your SMW hacking journey.
        </p>

        <h2>Overview/FAQ</h2>

        <p>
            Q. What is UberASM Tool?
        </p>

        <p>
            A. UberASM Tool is a program that lets you manage various UberASM resources, applying them to different levels (usually levels, but sometimes overworld maps, or game modes) as you wish.  UberASM Tool applies several hijacks in key places in an SMW ROM which allow it to run code for UberASM resources at specific times during the game, such as once per frame during levels.  This approach offers a good compromise between flexibility and ease of managing resources; resources can be added, removed, or applied to different levels easily.  You can generally do more things with a dedicated patch than with an UberASM resource, but removing a patch or having a patch be active only for certain levels is generally more difficult.  There's also much less risk of two UberASM resources conflicting with each other than there is for two patches.
        </p>

        <p>
            Q. What's new in 2.0, and what should I be aware of when upgrading to 2.0 from 1.x?
        </p>

        <p>
            A. Version 2.0 of UberASM Tool is a signficant update to the program.  If you try to run it out of the box with your existing <code class="path">list.txt</code> file, you'll notice an error during list processing that the <code>sprite:</code> command is no longer supported.  Simply change <code>sprite:</code> to <code>freeram:</code> in your <code class="path">list.txt</code>, and remove the <code>sprite-sa1:</code> line.  The way the global code file works has also changed.  See <a href="#Issues">Common Issues</a> below for how to convert any any resources that that use this.
        </p>
        <p>
            Other new features include:
        </p>
        <ul>
            <li>Multiple resources per level/overworld/game mode.  No more library workaround for combining resources.  See <a href="#ListFile">The List File</a> for more information.</li>
            <li>You can also specify resources that run on all levels (or overworld maps or game modes).  This mostly does away with the need to use game mode 14 for this purpose.  See <a href="#ListFile">The List File</a> for more information.</li>
            <li>The ability for resources to use extra bytes, similar to the way they're used for sprites.  This lets resources take parameters in the form of extra bytes supplied in <code class="path">list.txt</code>.  This lets you use the same resource in different configurations for different levels without having to make a copies, as you would have had to do previously.  See <a href="#ListFile">The List File</a> for more information.</li>
            <li>(For programmers) A new <code>end:</code> label to let resources run code at the end of frames.  This gives resources the opportunity to achieve certain effects that weren't possible with UberASM before.  See <a href="#Labels">Labels</a> below for more information.</li>
            <li>(For programmers) Support for shared routines, similar to (but slightly different than) those of Pixi and GPS.  See <a href="#Routines">Shared Routines</a> for more information.</li>
            <li>A bunch more little tweaks and improvements.  See the changelog for a full list.</li>
        </ul>

        <p>
            Q. Help!  ___ doesn't work anymore!
        </p>

        <p>
            A. That's not a question!  See the <code class="path">incompatibilities.txt</code> file for known incompatibilities and what to do about them.
        </p>

        <p>
            Q. I've downloaded a patch/block/sprite that has some uberasm, but the instructions don't really make sense with the current version of UberASM Tool.  What should I do?
        </p>

        <p>
            A. You've probably got something meant for the global code file or even the original UberASM patch.  See <a href="#Issues">Common Issues</a> below for steps to make them work.
        </p>

        <hr>

        <h2>Table of Contents:</h2>

        <ol type="I">
            <li>
                <a class="toclink" href="#General">General Use</a>
                <ol type="1">
                    <li><a class="toclink" href="#QuickStart">Quick Start</a></li>
                    <li><a class="toclink" href="#Running">Running UberASM Tool</a></li>
                    <li><a class="toclink" href="#ListFile">The List File</a></li>
                    <li><a class="toclink" href="#LibraryGeneral">The Library</a></li>
                    <li><a class="toclink" href="#Issues">Common Issues</a></li>
                </ol>
            </li>
            <li>
                <a class="toclink" href="#Technical">Technical Information</a>
                <ol type="1">
                    <li><a class="toclink" href="#Resources">Resources</a></li>
                    <li><a class="toclink" href="#Labels">Labels</a></li>
                    <li><a class="toclink" href="#DBR">The DBR</a></li>
                    <li><a class="toclink" href="#ExtraBytes">Extra Bytes</a></li>
                    <li><a class="toclink" href="#NMI">NMI</a></li>
                    <li><a class="toclink" href="#SA1">SA-1</a></li>
                    <li><a class="toclink" href="#LibraryTecnhnical">The Library</a></li>
                    <li><a class="toclink" href="#Routines">Shared Routines</a></li>
                    <li><a class="toclink" href="#Other">Other Code Files</a></li>
                    <li><a class="toclink" href="#DosDonts">Dos and Don'ts</a></li>
                </ol>
            </li>
            <li><a class="toclink" href="#Credits">Credits and Ackknowledgements</a></li>
        </ol>

        <hr>

        <h2 id="General">Part I: General Use</h2>

        <h3 id="QuickStart">Quick Start</h3>

        <ol type="1">
            <li>Copy the contents of the UberASM Tool <code class="path">.zip</code> file to a dedicated folder somewhere within your project.  Right now, best practice is to keep a separate copy of UberASM Tool for each project that you're working on (although there are plans to add flexibility here in a future version).</li>
            <li>Place the <code class="path">.asm</code> files for whatever UberASM resources you're using into the <code class="path">level/</code>, <code class="path">gamemode/</code>, or <code class="path">overworld/</code> folders as appropriate (most resources will be for levels, and resources may have additional instructions as well, so be sure to check for them).</li>
            <li>Edit your list file (usually <code class="path">list.txt</code> in the UberASM Tool folder) and change the <code>rom:</code> command to point to the location of your ROM file.  It can be given either relative to the UberASM Tool executable (like <code class="path">../myrom.smc</code>) or as an absolute path.</li>
            <li> If you're upgrading from 1.x and using an existing list file, remove the line with <code>sprite-sa1:</code> (if it's there), and on the line with <code>sprite: ...</code>, change <code>sprite</code> to <code>freeram</code>.</li>
            <li>Add the resources you want to use to the list file.  For example, to use a resource named <code class="path">LRonoff.asm</code> in the <code class="path">level/</code> folder for level 105, you'd add the line <code>105 LRonoff.asm</code> under the <code>level:</code> section of the list file.  See <a href="#ListFile">The List File</a> for more detail.</li>
            <li>Run <code class="path">UberASMTool.exe</code> (either double click on the icon, or run it from the command line).  See below for command line options and more.</li>
        </ol>

        <h3 id="Running">Running UberASM Tool</h3>

        <p>
            UberASM Tool has the command line syntax:
        </p>
<pre>
&gt; UberASMTool [&lt;list file&gt; [&lt;ROM file&gt;]]
</pre>
         <p>
            If no <code>&lt;list file&gt;</code> is given, UberASM Tool will use the file <code class="path">list.txt</code>.  If no <code>&lt;ROM file&gt;</code> is given, UberASM Tool will use the ROM file given by the <code>rom:</code> command in the list file.  For example:
        </p>
<pre>
rom: MyHack.smc         ; ROM file to use.
</pre>

        <p>
            All files may be given either as absolute paths or as paths relative to the UberASM Tool executable file.  Alternatively, you can simply double click the executable and it will run as if no command line arguments were given.
        <p>

        <h3 id="ListFile">The List File</h3>

        <p>
            The list file (<code class="path">list.txt</code> by default) contains configuration information for UberASM Tool, including what resources to use for what level/game mode/overworld map, along with some other information.  For commands that take file names, you can either give absolute paths, or you can give relative paths, in which case UberASM Tool will look relative the directory of the UberASM Tool executable.
        </p>

        <p>
            You may add comments to the list file.  A <code>;</code> or a <code>#</code> begins a comment, and the rest of the line is ignored.
        </p>

        <p>
            The following commands are available:
        </p>
        <dl>
            <dt><code>verbose: &lt;on/off/quiet/debug&gt;</code></dt>
            <dd>
                Sets the verbosity level for UAT.  This command is optional and defaults to "off" if not specified.
                <dl>
                    <dt><code>quiet</code></dt>
                    <dd>Only error messages are displayed</dd>

                    <dt><code>off</code></dt>
                    <dd>Basic information about progress is also displayed</dd>

                    <dt><code>on</code></dt>
                    <dd>
                        Extra information is displayed, such as individual library/ resource file progress, and a more detailed breakdown of total          insert size
                    </dd>

                    <dt><code>debug</code></dt>
                    <dd>
                        Even more detailed information is displayed for debugging purposes.  Also prevents UAT from deleting temporary files in asm/work/
                    </dd>
                </dl>
            </dd>

            <dt><code>rom: &lt;ROM file&gt;</code></dt>
            <dd>This specifies the ROM file that UberASM Tool will use.  A ROM file may also be given on the command line, which will override the list file command (and the command may be omitted altogether in this case).</dd>

            <dt><code>global: &lt;asm file&gt;</code></dt>
            <dt><code>statusbar: &lt;asm file&gt;</code></dt>
            <dt><code>macrolib: &lt;asm file&gt;</code></dt>
            <dd>These specify the <code class="path">.asm</code> files for the global code file, the status bar code file, and the macro library file.  These are all required, but there are defaults in place initially.  It's unlikely that you'll ever change these, but you can if you need to.  See below for more information about how these are used.</dd>

            <dt><code>freeram: &lt;RAM address&gt;</code></dt>
            <dd>Specifies 2 bytes of free RAM used to keep track of the previous game mode.  It must be given as as a full address in the <code>$7E0000-7FFFFF</code> range (<code>$400000-41FFFF</code> is okay too if using SA-1).  This command is required, but the default value in place initially will likely be fine.  More may be required in the future, but previous versions required 38 (68 on SA-1) bytes, rather than the current amount.</dd>

            <dt><code>level:</code></dt>
            <dt><code>overworld:</code></dt>
            <dt><code>gamemode:</code></dt>
            <dd>These commands indicate whether subseqent resources are for a level, an overworld map, or a game mode, respectively.  Resources must occur somewhere after one of these, but you can switch between them freely.</dd>
        </dl>

        <p>
            Finally, anything else is interpreted as assigning resources to levels/gamemodes/overworlds, which has the form:
        </p>
<pre>
&lt;number|*&gt; &lt;asm file&gt; [: &lt;extra byte 1&gt; &lt;extra byte 2&gt; ...] [, ...]
</pre>

        <p>
            <code>&lt;number&gt;</code> is the level number (0-1FF), game mode number (0-FF), or overworld map number (0-6, 0 = Main map; 1 = Yoshi's Island; 2 = Vanilla Dome; 3 = Forest of Illusion; 4 = Valley of Bowser; 5 = Special World; and 6 = Star World).  Numbers here must be in hexadecimal.  You can also specify <code>*</code> instead of a number, which is a special value that indicates that this resource is to run on all levels (or game modes, or overworld maps).
        </p>

        <p>
            <code>&lt;asm file&gt;</code> is the name of the resource file to use.  For levels, UAT looks relative to the <code class="path">level/</code> folder, for game modes, the <code class="path">gamemode/</code> folder, and for overworlds, the <code class="path">overworld/</code> folder.  You may give paths relative to these, or you may also give an absolute path.
        </p>

        <p>
            If a resource uses extra bytes (see below for more information), you must specify them after the resource file name with a <code>:</code> followed by the actual bytes to use.  For more than one byte, separate them by spaces.  Bytes are given in hexadecimal by default (or explicitly by prefixing with <code>$</code> or <code>0x</code>), but you can also give them in decimal by prefixing with an <code>@</code>, or in binary by prefixing with a <code>%</code>.  You may also specify negative numbers here.  So for example, <code>-10</code>, <code>F0</code>, <code>$f0</code>, <code>@-16</code>, <code>@240</code>, and <code>%11110000</code> all refer to the same value.
        </p>

        <p>
            You may also assign more than one resource to each level/game mode/overworld map, including <code>*</code>.  Simply add them in order, separated by commas.  You may split resources over separate lines if you wish, but the comma must go on the same line as preceding resource.  Note that if multiple resources are given for a single level (or game mode or overworld map), UAT executes them in the order they are given, and resources under <code>*</code> are called first.  This usually doesn't matter, but it can sometimes be something to keep in mind.
        </p>

        <p>
            An example (just the resources are given; the other commands are omitted for clarity:
        </p>
<pre>
; Example list file...this line is a comment.
# so is this

level:
   105 incio.asm
   106 incio.asm,                 ; comment here too
       waves.asm, gradient.asm

overworld:
* music.asm

level:
107 special.asm:@100, ../overworld/music.asm
</pre>
        <ul>
            <li><code>level:</code> says we're now giving resources for levels</li>
            <li>level 105 is assigned the resource <code class="path">incio.asm</code> (which is in the <code class="path">level/</code> folder)</li>
            <li>level 106 is assigned the three resources <code class="path">incio.asm</code>, <code class="path">waves.asm</code>, and <code class="path">gradient.asm</code></li>
            <li><code>overworld:</code> says we're now giving resources for overworld maps</li>
            <li>the resource <code class="path">music.asm</code> (in the <code class="path">overworld/</code> folder) is assigned to all overworlds</li>
            <li><code>level:</code> switches back to specifying resources for levels</li>
            <li>level 107 is assigned the resource <code class="path">special.asm</code> (which takes one extra byte) with an extra byte of 100 (decimal), and then the resource <code class="path">music.asm</code> from the <code class="path">overworld/</code> folder.</li>
        </ul>

        <h3 id="LibraryGeneral">The Library</h3>
        <p>
            Some resources may come with external library files.  These should be placed in UberASM Tool's <code class="path">library/</code> folder.  Any files in here are automatically included in your ROM and made available to UberASM resources.  See <a href="#LibraryTechnical">below</a> for more technical detail on UberASM's library system.
        </p>

        <h3 id="Issues">Common Issues</h3>

        <p>
            You may run into resources (patches, uberasm, etc) that want you to copy and paste some code into UberASM Tool's global code file.  If that code was destined for the <code>init:</code> label, it should work the same, but previous versions (1.x) also had support for <code>main:</code>, <code>load:</code>, and <code>nmi:</code> labels, which are no longer used.  For code that goes under <code>load:</code>, make a new file and place the code under a <code>load:</code> label, but ending with <code>RTL</code> instead of <code>RTS</code> as the instructions might suggest.  So,
        </p>
<pre>
load:
    &lt;code to paste&gt;
    RTL
</pre>
        <p>
            Then put the new file in UAT's <code class="path">level/</code> folder and add it as a resource for level <code>*</code> in your list file.
        </p>

        <p>
            Similarly, for code that goes under <code>main:</code>, make a new file and place the code under both <code>main:</code> and <code>init:</code>. So,
        </p>
<pre>
init:
main:
    &lt;code to paste&gt;
    RTL
</pre>
        <p>
            Then put the new file in UAT's <code class="path">gamemode/</code> folder and add it as a resource for game mode <code>*</code> in your list file.  For global code for the <code>nmi:</code> label, do the same, but just place it under <code>nmi:</code> in a new file.
        </p>

        <p>
            As of the 2.0 release of UberASM Tool, there are a couple incompatible patches: lx5's NSMB star coins patch, and HammerBrother's SMA2 Slide Kill Chain patch.  Assuming they haven't been updated by the time you read this, see the <code class="path">incompatibilities.txt</code> file for instructions on making them work with the new version.
        </p>

        <p>
            Some even older resources may talk about pasting code under <code>level###:</code> or something similar.  If you run into this situation, you'll want to make a new <code class="path">.asm</code> file (for level, overworld, or game mode, as appropriate) and paste the given code under a label called <code>main:</code>, but ending with <code>RTL</code> instead of <code>RTS</code>.  Similarly, do the same for code for <code>level###init:</code>, place it under the <code>init:</code> instead.  Then add the new file to your list.txt wherever you want to use it.
        </p>

        <p>
            As of version 2.0, UberASM Tool will refuse to run on a ROM that has had a newer version of UberASM Tool used on it.  It's recommended that you simply upgrade to the current version in this case.  If for some reason you can't do that, you can force it to run by editing the <code class="path">asm/base/clean.asm</code> file, and changing the <code>!OldVersionOverride</code> define to 1.  But do so at your own risk; future versions may introduce breaking changes that will prevent older versions from cleaning up correctly.  Also note that versions 1.x make no such check and will attempt to run anyway.  As of 2.0, it should still work properly, but again, this may change in the future.
        </p>

        <p>
            Resources wanting to access the sprite load table (unlikely, but possible) need to know if it's been remapped by Pixi.  UberASM Tool looks to see if Pixi has marked it so and sets some defines appropriately.  However, if Pixi has not been run yet, then UberASM Tool will assume the remap hasn't happened, when in fact it might be done later.  To work around this, you can either rerun UberASM Tool after Pixi, or add the line <code>%Force255SpritesPerLevel()</code> to the your macro library file (<code class="path">other/macro_library.asm</code> by default).  Note that the sprite load table defines in versions of UberASM Tool prior to 2.0 simply didn't account for the remap possibility, and any resources relying on them would have likely failed in this case anyway.
        </p>

        <hr>

        <h2 id="Technical">Part II: Technical Information</h2>

        <p>
            The following sections describe the technical aspects of UAT in more detail.  This is mainly intended for programmers and resource creators.  If you're making a hack without getting into the details of ASM programming, you can probably skip this part, although there may still be some useful information here.
        </p>

        <h3 id="Resources">Resources</h3>

        <p>
            Resources are the main entities that UberASM Tool uses to achieve effects in the game.  They can be used for levels, for particular game modes, or for particular overworld maps.  However, there's no fundamental difference between the types, and a level resource can also be used as an overworld resource, for example.  To make a resource for UberASM Tool, you simply need an <code class="path">.asm</code> file that contains one or more special labels that UAT calls.  These labels are <code>main:</code>, <code>init:</code>, <code>nmi:</code>, <code>load:</code> (for levels only), and <code>end:</code> (new to v2.0).  See below for more specific information on each label.  For example, here's a level resource that drains one coin from Mario every 4 frames:
<pre>
main:
    LDA $9D
    BEQ .Return      ; don't run if sprites are locked
    LDA $0DBF|!addr
    BEQ .Return      ; don't run if already at 0 coins
    LDA $14
    AND #$03
    BNE .Return      ; only run every 4th frame
    DEC $0DBF|!addr  ; decrement coin count
.Return:
    RTL
</pre>

        <p>
            As of v2.0, resources can also specify that they take extra bytes, similar to extra bytes for custom sprites.  For example, suppose you have an UberASM resource for a wind effect that pushes on Mario.  Previously, such a resource might have needed to use a define to set the wind speed.  So if someone wanted to use the same effect in different levels with different wind speeds, they'd have to make separate copies of the resource with a different define value for each one.  This wastes ROM space and makes organization difficult for the hack creator.  Instead, now you can simply have your resource take an extra byte that gives the wind speed, and the same resource can be used in multiple levels with different wind speed values.  See <a href="#ExtraBytes">Extra Bytes</a> for more information on how to write resources that use this feature, and see <a href="#ListFile">The List File</a> for how users can specify extra bytes for resources in the list file.
        </p>


        <h3 id="Labels">Labels</h3>

        <p>
            The labels <code>main:</code>, <code>init:</code>, <code>end:</code>, and <code>nmi:</code> are available for all resource types, and level resources additionally have the <code>load:</code> label.
        </p>
        <p>
            For levels, the <code>load:</code> label is called once, early in the level loading process.  The primary purpose of this is to set up Lunar Magic's conditional direct map16 flags.  See the Lunar Magic documentation for more information about this.  The <code>init:</code> label is also called once, after the level is done loading and before fade-in.  The <code>main:</code> label is called once at the beginning of each frame during normal level operation (in game mode $14), and <code>end:</code> is likewise called at the end of each frame (but before the OAM table information at $0420 is copied to $0400).
        </p>
        <p>
            Overworld resource labels are similar, but run in game mode $0E (and have no <code>load:</code> label).
        </p>
        <p>
            Game mode code's <code>init:</code> and <code>main:</code> labels will run at the start of the main game loop.  On the first frame the mode is active, <code>init:</code> is run, and on all subsequent frames, <code>main:</code> is run.  The <code>end:</code> label is run after the entire rest of the game loop, including the $0420 -> $0400 conversion routine.  You may have noticed that UberASM Tool supports game modes $00-FF, even though SMW only uses game modes $00-29.  Any game mode $2A or higher is a custom mode, and thus there will be no base SMW routine to run for that frame (except for the standard NMI routine).
        </p>
        <p>
            For all resource types, the <code>nmi:</code> label runs early during SMW's NMI routine.  Level resources have their NMI label called during game modes $13 and $14, and overworld resources during game modes $0D and $0E.  In both cases, actual game mode code under "nmi:" will run first.  See <a href="#NMI">NMI</a> for more information.
        </p>

        <h3 id="DBR">The DBR</h3>

        <p>
            By default, UAT sets the DBR (data bank register) to the appropriate bank when calling resource code for labels other than <code>nmi:</code>.  This behavior is often not needed, and can be turned off for a resource if its <code class="path">.asm</code> file contains the exact line (starting at column 1) <code>;&gt;dbr off</code> somewhere in the source file.  Note that if you do need to set it manually, you don't need to worry about restoring it (unless set to a bank without RAM mirrors); UAT will do so after all resources have been called.
        </p>

        <h3 id="ExtraBytes">Extra Bytes</h3>

        <p>
            To tell UberASM Tool that a resource takes extra bytes, it must contain a line of the exact form (starting at column 1) <code>;&gt;bytes &lt;number&gt;</code> somewhere in the resource's <code class="path">.asm</code> file.  Only the first such line is read, and <code>&lt;number&gt;</code> must be a decimal number in the range 0-255 that says how many extra bytes this resource uses.
        </p>
        <p>
            Generally UAT passes a 16-bit pointer to the extra bytes for the current level/gamemode/overworld in $00-01.  So for example, to load the third extra byte, you can use the code:
        </p>
<pre>
main:
    LDY #$02              ; load the offset into Y, first byte at offset $00, etc.
    LDA ($00),y           ; load the accumulator with the extra byte whose offset is in Y
    ; do something
    ; ...
    RTL
</pre>
        <p>
            Note that this relies on the DBR being set prior to running this code.  UAT sets it by default, but that behavior can be disabled (see <a href="#DBR">The DBR</a> for more info), so you'd either need to set it yourself, or just not disable it in the first place.
        </p>
        <p>
            However, there's one case where it's different &ndash; namely in the <code>nmi:</code> label on SA-1 roms.  Here, the pointer is placed on the stack, 4 bytes from the top.  So for example again, to access the third byte, you can use the code:
        </p>
<pre>
nmi:
    PHK : PLB             ; the DBR must be set to the current bank
    LDY #$02              ; load the offset into Y -- first byte at offset $00, etc.
    LDA ($04,s),y         ; load the accumulator with the extra byte whose offset is in Y
    ; do something
    ; ...
    RTL
</pre>
        <p>
            Note that you must be careful that if anything is pushed onto the stack before reading the extra byte data (which can happen if this code is in a subroutine that has been <code>JSR</code>ed to, for example), you must take this into account when loading extra byte data.
        </p>
        <p>
            To write hybrid lorom/sa-1 <code>nmi:</code> code as above, you might have something like:
        </p>
<pre>
nmi:
    PHK : PLB
    LDY #$02
    if !sa1
        LDA ($04,s),y
    else
        LDA ($00),y
    endif
    ; do something
    ; ...
    RTL
</pre>
        <p>
            Note that if you write a resource that uses extra bytes, but someone attempts to insert it with an older (1.x) version of UberASM Tool, it will still appear to insert, but it won't work correctly.  You can use the <code>%require_uber_ver()</code> macro to cause it to fail to insert in older versions; see <a href="#Other">Other Code Files</a> for more information.
        </p>

        <h3 id="NMI">NMI</h3>

        <p>
            There are some special considerations that should be taken into account for UberASM code that runs under the <code>nmi:</code> label.  If a resource uses extra bytes, the way these are accessed here is different on SA-1; see <a href="#ExtraBytes">Extra Bytes</a> for more detail.
        </p>
        <p>
            If the game's NMI routine (which includes UberASM Tool's calling of resources' <code>nmi:</code> labels) takes too long, there can be noticeable graphical glitches, generally black bars at the top of the screen.  To help avoid this, NMI code should be optimized for speed.  To this end, UAT does not set the DBR for resources when calling the <code>nmi:</code> label.  You're free to do so if you need, and if so, it does not need to be restored before  returning (as long as it's set to a bank with RAM mirrors).  See <a href="#DBR">The DBR</a> for more detail.
        </p>
        <p>
            Finally, the main game code may not have finished running by the time that NMI code is run (i.e., the game is lagging, or experiencing slowdown).  If this is the case, the value in memory location $10 will be nonzero, and you may not want to run your NMI code at all.  If you do, special care needs to be taken on SA-1 (including hybrid resources that might run on either), since the SA-1 CPU does not get halted during NMI, but continues to run alongside the regular SNES CPU.  In this case, normal scratch memory ($00-0F) is not safe to use.  Instead, you can use absolute addressing, $0000-000F, which is scratch WRAM that the SA-1 CPU has no access to.  Any scratch memory that you use during lag must be preserved, with the exception of $00-01 ($0000-0001 on SA-1); UberASM Tool uses this itself and restores it after all resources have been called.
        </p>

        <h3 id="LibraryTechnical">The Library</h3>

        <p>
            UberASM Tool supports a system for shared library code that different resources can access.  Files for the shared library should be placed in the <code class="path">library/</code> directory.  You can have source (<code class="path">.asm</code>) files, or binary (anything else) files.
        </p>
        <p>
            Binary files simply get included (via an <code>incbin</code>) verbatim, with a single label exposed with name the same as the file's name without the extension.  For example, if there's a file called <code class="path">library/PlayerGfx.bin</code>, then all resources will have the label <code>PlayerGfx:</code> available at the start of the file's contents.  Each binary file will have its own <code>freedata</code> area in the ROM.  Likewise, source files get included into their own <code>freecode</code> region.  Any labels in a source file will be available to resources with the file name prefixed.  So for example, if the file <code class="path">library/math.asm</code> contains the labels <code>sqrt:</code> and <code>atan2:</code>, then you can call these as routines with <code>JSL math_sqrt</code> and <code>JSL math_atan2</code>, respectively.  Be aware that the DBR is not set automatically.
        </p>
        <p>
            Since the filenames are used as label prefixes, library file names must be valid Asar labels.  They must start with a letter and contain only letters, numbers, and underscores.  However, they can also contain spaces, which UberASM Tool will convert to underscores.  Furthermore, you may place library files into subdirectories.  Label prefixes for files in subdirectories will have slashes converted to underscores.  For example, the file <code class="path">library/stuff/My routine.asm</code> will have its labels prefixed with <code>stuff_My_routine_</code>.
        </p>
        <p>
            There a couple main disadvantages of the library system.  First, library files are included in the ROM whether or not they're actually used.  So you may wind up with wasted ROM space.  Second, library files cannot call other library files.  However, as of version 2.0, UberASM Tool has support for a <a href="#Routines">shared routine system</a> similar to that of Pixi and GPS which overcomes these limitations.
        </p>

        <h3 id="Routines">Shared Routines</h3>

        <p>
            UberASM Tool 2.0 adds support for shared routines.  These are similar to those of Pixi and GPS, but are implemented a little differently.  Shared routines are simply <code class="path">.asm</code> files that have common code that different resources can call (one routine per file).  To call a shared routine called <code>name</code>, add the line <code>%UberRoutine(name)</code> to your resource code.  (This differs from Pixi and GPS, where you'd simply call <code>%name()</code> instead).  Routine files must be located in the <code class="path">routines/</code> directory; see there for what's already included and available to use.  Note that unlike libraries, routines are added to the ROM on-demand.  If nothing uses a routine, it won't take up any space in the ROM.  Also unlike libraries, shared routines may call other shared routines freely.  And note that libraries may call shared routines.  On the other hand, whether or not a shared routine can call a library will depend on where the routine is first used &ndash; if it's first used from a resource, it will work, but if it's first used from a library, it won't (because libraries can't call other libraries).  It's probably best to just avoid this case altogether.
        </p>
        <p>
            To make your own shared routine, simply create a new <code class="path">.asm</code> file with the name of the routine in the <code class="path">routines/</code> directory (directly, not in a subdirectory).  Execution starts at the beginning of the file; no label is needed there.  The routine is <code>JSL</code>ed to, so the DBR is not set automatically, and your routine should end with an <code>RTL</code>.
        </p>
        <p>
            <strong>IMPORTANT:</strong> Due to the way shared routines are implemented, any labels in the routine MUST be macro-local.  That is, they must start with a question mark.
        </p>
        <p>
            So, for example, a shared routine that returns the first open sprite slot in <code>X</code> (or $FF if there are none) might look like the following:
        </p>
<pre>
    LDX #!sprite_slots-1
?-
    LDA !sprite_status,x
    BEQ ?Return
    DEX
    BPL ?-
?Return:
    RTL
</pre>
        <p>
            If you place this as the file <code class="path">routines/FindFreeSpriteSlot.asm</code>, then you can then call this from any library, resource, or other shared routine file by using <code>%UberRoutine(FindFreeSpriteSlot)</code>.
        </p>

        <h3 id="Other">Other Code Files</h3>

        <p>
            The macro library file (given by <code>macrolib:</code> in the list file) is included in every file assembled by UberASM Tool &ndash; resources, libraries, routines.  If you wish, you can place common defines and macros here.  Previous versions also put standard defines and macros here, but those have now been split out into <code class="path">asm/base/uber_defines.asm</code>.  Some pre-existing macros of note:
        </p>
        <dl>
            <dt><code>%require_uber_ver(major, minor)</code></dt>
            <dd>Fails if the current version of UberASM Tool is less than <code>major.minor</code>.  This will also cause a resource to fail on 1.x versions as well since this macro is new to 2.0.  This is particularly useful for files with extra bytes since they'll appear to insert with older versions, but not work correctly due to the extra bytes not being passed.</dd>

            <dt><code>%invoke_sa1(label)</code></dt>
            <dd>Useful if you want to run some code on the SA-1 CPU; see <a href="#SA1">SA-1</a> for more detail.</dd>

            <dt><code>%prot_file(file, label)</code></dt>
            <dt><code>%prot_source(file, label)</code></dt>
            <dd>These include binary and source files respectively at the given label, but puts them in their own freedata/freecode blocks, especially useful for large binary files.</dd>
        </dl>
        <p>
            The global code file (given by <code>global:</code> in the list file) has its <code>init:</code> label called by UberASM Tool fairly early in SMW's overall initailization. Code here should end with <code>RTS</code> instead of <code>RTL</code>.  Note that older versions of UberASM Tool also had labels for <code>main:</code>, <code>nmi:</code>, and <code>load:</code>, but these are no longer supported.  See <a href="#Issues">Common Issues</a> for how to use code intended for these labels.  Note, though, that there's one small difference here.  previously, global <code>main:</code> code would run before the global frame counter (at $13) was incremented, while code converted to run for UberASM Tool 2.0+ runs after the frame counter is incremented.  This is unlikely to matter, but it's worth noting.
        </p>
        <p>
            The status bar code file (given by <code>statusbar</code> in the list file) has only one label used, <code>main:</code>, which is run during levels, a little later than normal <code>main:</code> code, right before the status bar is updated.  Any code here should also end in <code>RTS</code> instead of <code>RTL</code>.
        </p>
        <p>
            Note that unlike regular resources, code for the status bar and global code files is included with the main UberASM patch, rather than getting their own freecode blocks.  Due to how the main patch is built, you can't use the <code>%prot</code> macros or shared routines that haven't already been called at least once in the global code or status bar code files.
        </p>

        <h3 id="SA1">SA-1</h3>

        <p>
            If using UberASM Tool on an SA-1 ROM, note that all resources still run on the SNES CPU side by default.  If you want to take advantage of the speed boost that the SA-1 CPU offers, you can use the <code>%invoke_sa1(label)</code> macro to run the routine at <code>label:</code> on the SA-1 CPU. The called routine should end in an <code>RTL</code>, and the DBR is not set automatically, so you will have to do so if needed.  To use this in a hybrid resource, then, some example code might look like:
        </p>
<pre>
; ... main resource code
if !sa1
    %invoke_sa1(MyRoutine)
else
    JSL MyRoutine
endif
; ... main code continues

...

MyRoutine:
    if !sa1
        PHB : PHK : PLB    ; save/set the DBR (if needed)
    endif

    ; ... routine body

    if !sa1
        PLB     ; restore the DBR (if it was set above)
    endif

    RTL
</pre>
        <p>
            There are some extra things to consider when running NMI code on an SA-1 ROM.  See <a href="#NMI">NMI</a> for more detail, and <a href="#ExtraBytes">Extra Bytes</a> if making a resource that needs to access extra bytes during NMI.
        </p>
        <p>
            As of version 2.0, you can now also specify that UberASM Tool should run resource labels on the SA-1 CPU if it's available (i.e., it's safe to use this option on all ROMs &ndash; it simply does nothing on non-SA-1 ROMs).  This works for any resource labels except <code>nmi:</code> &ndash; it will always be called on the SNES side.  To do so, have a line in the resource <code class="path">.asm</code> file exactly of the form <code>;&gt;sa1 &lt;comma separated list of labels&gt;</code>, with no extra spaces.  For example, if a resource file contains the line <code>;&gt;sa1 main,end</code>, then SA-1 ROMs will have <code>main:</code> and <code>end:</code> run on SA-1, while <code>init:</code> and <code>load:</code> (if present) will run on the SNES side.  Since older versions of UberASM Tool don't support this feature, consider using <code>%require_uber_version(2, 0)</code> here, especially if you have code that won't work properly without the SA-1 CPU being invoked as expected (such as when using the multiplication and division registers).  Also keep in mind that there's some overhead in invoking the SA-1 CPU, so it may not be worth it for very short routines.  The DBR will still be set by default, unless the resource file also contains <code>;&gt;dbr off</code>.  See <a href="#DBR">The DBR</a> for more information.
        </p>

        <h3 id="DosDonts">Dos and Don'ts</h3>

        <p>
            Just a few random reminders for good practice when making resources:
        </p>
        <ul>
            <li>UAT turns on nested namespaces for resources and libraries; DON'T turn them off.  And if you do set a namespace in your code somewhere, DO make sure to exit it as well.</li>
            <li>DON'T add your own hijacks.  It's possible to do, but it runs the risk of confusing the patching process.  Just leave patches in a separate file to be applied with Asar directly.</li>
            <li>DO <code>%require_uber_ver(2, 0)</code> if your resource uses extra bytes.  Failing to do so will let someone add it with version 1.x appear to add it, but it won't work correctly due to lack of extra byte support.  Consider including this even for features that will explicitly fail on older versions.  This helps the user know quickly that they need to upgrade.</li>
        </ul>

        <hr>

        <h2 id="Credits">Credits and Acknowledgements</h2>

        <p>
            UberASM Tool was inspired by GPS, Sprite Tool, edit1754's levelASM tool, levelASM+NMI version and 33953YoShI's japanese levelASM tool.
        </p>
        <p>
            <a href="https://github.com/RPGHacker/asar">Asar 1.81</a>, currently maintained by RPGHacker
        </p>
        <p>
            <a href="https://github.com/benjamin-hodgson/Pidgin">Pidgin 3.2.0</a> by Benjamin Hodgson
        </p>
        <p>
            Vitor would like to thank:
        </p>
        <ul>
            <li>edit1754 for the original LevelASM Tool idea;</li>
            <li>p4plus2 for the original uberASM patch;</li>
            <li>Alcaro/byuu/Raidenthequick for Asar; and</li>
            <li>33953YoShI/Mirann/Wakana for testing.</li>
            <li>33953YoShI again for giving me the LOAD label base hijack and idea.</li>
        </ul>
        <p>
            Fernap would also like to thank:
        </p>
        <ul>
            <li>Atari2.0 and TheBiob for help with Visual Studio</li>
        </ul>

        <h3>Contact</h3>
        <p>
            You can contact Vitor though the following links:
        </p>
        <ul>
            <li><a href="https://github.com/VitorVilela7">Github profile</a></li>
            <li><a href="https://twitter.com/HackerVilela">Twitter profile</a></li>
            <li><a href="https://vilela.sneslab.net/">Personal blog</a></li>
        </ul>
        <p>
            You can contact Fernap at
        </p>
        <ul>
            <li><a href="https://www.smwcentral.net/?p=pm&do=compose&user=48050">SMWC profile</a></li>
            <li>As Fernap#8699 on <a href="https://discord.gg/smwc">the SMWC Discord</a></li>
        </ul>

    </body>
</html>
